<!doctype html><html lang=en-us class="section-notes type-notes layout-none kind-page"><head><title>Roomba zones in Home Assistant | Jeff Fredrickson</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta name=theme-color content><script type=text/javascript src=/js/theme.js></script><link rel=stylesheet href=/css/tailwind.9b263c0e8e4aee4e49ee44cd20c4443dd1fb5144ce2833d6c84c486add711e12.min.css><link rel=stylesheet href=/css/main.css></head><body><div class="flex flex-col min-h-screen"><nav class="py-4 md:py-6 m-0 font-sans font-bold bg-neutral-100 dark:bg-neutral-900 border-b border-neutral-200 dark:border-neutral-800" role=navigation aria-label="main navigation"><div class=container><div class="flex items-center justify-between"><a class="text-2xl font-['Bungee']" href=/>Jeff Fredrickson</a><div class="hidden md:flex items-center"><a class="p-2 mx-1 text-sm hover:bg-white hover:dark:bg-black hover:rounded-sm" href=/notes/>Notes</a>
<a class="p-2 mx-1 text-sm hover:bg-white hover:dark:bg-black hover:rounded-sm" href=/projects/>Projects</a>
<a class="p-2 mx-1 text-sm hover:bg-white hover:dark:bg-black hover:rounded-sm" href=/contact/>Contact</a></div><div class="md:hidden flex items-center"><button type=button class="nav-burger p-2" data-target=nav-mobile-items aria-controls=nav-mobile-items aria-expanded=false>
<span class=sr-only>Main menu</span><svg xmlns="http://www.w3.org/2000/svg" class="nav-burger-icon-open h-6 w-6 block" stroke="currentcolor" fill="currentcolor" viewBox="0 0 448 512"><path d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="nav-burger-icon-close h-6 w-6 hidden" stroke="currentcolor" fill="currentcolor" viewBox="0 0 320 512"><path d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
<img class="cheezburger h-6 w-6 hidden" src=/images/nav-hamburger.png></button></div></div><div class="max-h-0 overflow-hidden transition-all duration-300" id=nav-mobile-items><div class="flex flex-col pt-2 divide-y-2 dark:divide-neutral-800"><a class="p-2 flex justify-end text-sm" href=/notes/>Notes</a>
<a class="p-2 flex justify-end text-sm" href=/projects/>Projects</a>
<a class="p-2 flex justify-end text-sm" href=/contact/>Contact</a></div></div></div></nav><div class="py-8 md:py-16 mb-2 md:mb-4 bg-neutral-100 dark:bg-neutral-900"><div class=container><nav aria-label=breadcrumbs><ul class="p-0 m-0 text-xs font-sans list-none"><li class=inline><a href=/notes/>Notes</a><span class="px-1 after:content-['\02192']"></span></li></ul></nav></div><div class=container><div class="w-full xl:w-3/4"><h1 class=mt-0>Roomba zones in Home Assistant</h1><p class="mt-2 text-xl font-sans font-bold text-neutral-500 dark:text-neutral-400 tracking-tight">How to refer to custom Roomba zones in Home Assistant scripts</p></div></div><div class=container><span class="py-1 px-1.5 m-0.5 leading-loose bg-secondary-500 dark:bg-secondary-800 font-sans text-xs whitespace-nowrap rounded-sm"><a href=/tags/smart-home/ class="no-underline font-bold text-white dark:text-neutral-200">smart-home</a></span>
<span class="py-1 px-1.5 m-0.5 leading-loose bg-secondary-500 dark:bg-secondary-800 font-sans text-xs whitespace-nowrap rounded-sm"><a href=/tags/home-assistant/ class="no-underline font-bold text-white dark:text-neutral-200">home-assistant</a></span>
<span class="py-1 px-1.5 m-0.5 leading-loose bg-secondary-500 dark:bg-secondary-800 font-sans text-xs whitespace-nowrap rounded-sm"><a href=/tags/iot/ class="no-underline font-bold text-white dark:text-neutral-200">iot</a></span></div></div><main id=main class="main flex-grow"><div class=container><div class="w-full xl:w-3/4"><p>There doesn&rsquo;t appear to be a straightforward way to have Home Assistant work with custom Roomba zones. It takes some legwork.</p><p>I&rsquo;ve designated a Roomba zone around our <a href=https://www.litter-robot.com/>Litter-Robot</a> with the intention of having the vacuum clean up any stray litter after one of the cats uses the litter box.</p><p>But in order to get a Home Assistant script to send the Roomba to that zone, I need to know the Roomba&rsquo;s <code>pmap_id</code> and <code>region_id</code> fields from the iRobot API. Fortunately, <a href=https://github.com/koalazak/dorita980>dorita980</a> makes this easy by providing a JavaScript wrapper around the iRobot API.</p><h2 id=steps>Steps</h2><p>First, you&rsquo;ll need to know your Roomba&rsquo;s IP address. Your router&rsquo;s DHCP lease table typically has this information.</p><p>In Home Assistant, if the <a href=https://www.home-assistant.io/integrations/roomba/>Roomba integration</a> has continuous mode enabled, turn it off. The continuous mode option can be found by going to Settings -> Devices & Services -> Integrations and clicking Configure under the Roomba integration. This tells Home Assistant to stop hitting the Roomba&rsquo;s local API. The Roomba API can only handle one connection at a time, and we&rsquo;ll need to have access to it.</p><p><a href=https://homesupport.irobot.com/s/article/28252>Set up a new clean zone</a> in the Roomba app if you haven&rsquo;t already done so.</p><p>Install <a href=https://github.com/jfredrickson/irobot-tools>irobot-tools</a>. This will include the dorita980 library, which in turn includes a handy script to find your Roomba&rsquo;s local API authentication data. It gets this by looking it up in the iRobot cloud service using your iRobot username and password:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npx get-roomba-password-cloud &lt;your iRobot username&gt; &lt;your iRobot password&gt;</span></span></code></pre></div><p>This will output something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Found 1 robot(s)!
</span></span><span class=line><span class=cl>Robot &#34;Roomba&#34; (sku: i855020 SoftwareVer: lewis+22.21.1+2022-06-02-570490a425b+Firmware-Build+1339):
</span></span><span class=line><span class=cl>BLID=&gt; ABCDEF0123456789ABCDEF0123456789
</span></span><span class=line><span class=cl>Password=&gt; :1:0123456789:acbdefghijklmnop &lt;= Yes, all this string.</span></span></code></pre></div><p>There&rsquo;s your BLID and password! This BLID and password will be used in the next step authenticate to the Roomba&rsquo;s local API.</p><p>Use iRobot&rsquo;s app on your mobile device to tell the Roomba to start vacuuming your custom zone. Immediately after it starts, use this script from <code>irobot-tools</code> to find the last command that was issued to the Roomba:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./get-last-command &lt;BLID&gt; &lt;password&gt; &lt;IP address&gt;</span></span></code></pre></div><p>Example output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;command&#34;</span><span class=p>:</span> <span class=s2>&#34;start&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;initiator&#34;</span><span class=p>:</span> <span class=s2>&#34;rmtApp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;time&#34;</span><span class=p>:</span> <span class=mi>1658690508</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;favorite_id&#34;</span><span class=p>:</span> <span class=s2>&#34;0123456789abcdef0123456789abcdef&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;robot_id&#34;</span><span class=p>:</span> <span class=s2>&#34;ABCDEF0123456789ABCDEF0123456789&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;pmap_id&#34;</span><span class=p>:</span> <span class=s2>&#34;b1x9ivlRXq1N7JfLcywbRV&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;regions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;noAutoPasses&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;twoPass&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;region_id&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;zid&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;user_pmapv_id&#34;</span><span class=p>:</span> <span class=s2>&#34;220724T170713&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;ordered&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>And there&rsquo;s the <code>pmap_id</code> and <code>region_id</code>.</p><p>At this point, you can now restore continuous mode in Home Assistant.</p><p>Now in Home Assistant, you can create a script to tell the Roomba to vacuum this custom zone. The script should include a sequence item containing:</p><ul><li><strong>Action type:</strong> Call service</li><li><strong>Service:</strong> Vacuum: Send command</li><li><strong>Targets:</strong> (select your Roomba)</li><li><strong>Command:</strong> start</li><li><strong>Parameters:</strong><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>pmap_id</span><span class=p>:</span><span class=w> </span><span class=l>b1x9ivlRXq1N7JfLcywbRV</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>regions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>region_id</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>zid</span></span></span></code></pre></div></li></ul></div></div></main><footer class="mt-12 p-8 font-sans bg-neutral-100 dark:bg-zinc-900"><div class=container><div class="flex items-center justify-between"><div class="flex flex-col sm:flex-row sm:items-center justify-start text-xs"><a href=https://github.com/jfredrickson/jfredrickson.github.io><span class="fas fa-brands fa-github"></span>
<span>GitHub</span></a>
<span class="hidden sm:flex mx-2">/</span>
<span>code: <a href=https://github.com/jfredrickson/jfredrickson.github.io/blob/main/LICENSE>AGPLv3</a></span>
<span class="hidden sm:flex mx-2">/</span>
<span class=flex xmlns:cc=http://creativecommons.org/ns# xmlns:dct=http://purl.org/dc/terms/><span>content:</span>
<a class="flex items-center mx-1" href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer">CC BY 4.0
<img class="h-4 w-4 ml-1" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1">
<img class="h-4 w-4 ml-1" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"></a></span></div><div class="flex justify-center relative"><button type=button class="theme-toggle-button p-2 text-primary-600 dark:text-primary-300"><svg xmlns="http://www.w3.org/2000/svg" class="block dark:hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="hidden dark:block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg></button><ul class="theme-toggle-menu hidden absolute z-50 bottom-4 px-1 py-1 list-none rounded bg-white dark:bg-black"><li><a class="theme-toggle-menu-item flex items-center py-1 px-3 text-sm rounded hover:text-white hover:bg-primary-600" data-theme=dark href=#><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg><span class=ml-1>Dark</span></a></li><li><a class="theme-toggle-menu-item flex items-center py-1 px-3 text-sm rounded hover:text-white hover:bg-primary-600" data-theme=light href=#><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span class=ml-1>Light</span></a></li><li><a class="theme-toggle-menu-item flex items-center py-1 px-3 text-sm rounded hover:text-white hover:bg-primary-600" data-theme=auto href=#><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17 9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5A2 2 0 003 5v10a2 2 0 002 2z"/></svg><span class=ml-1>Auto</span></a></li></ul></div></div></div></footer></div><script type=text/javascript src=/js/main.js></script></body></html>